#error_message.alert.alert-danger.mt-3
- has_image = @user.persisted? && @user.profile_image
img#profile_image.mb-3 style="max-height:80vh" src=(profile_image_user_path(@user) if has_image)
video#video.text-center.w-100 width="320" height="240" autoplay='autoplay' style=('display: none' if has_image)
canvas#canvas width="320" height="240" style='display: none'
.text-center.mb-3
  button#start.btn.btn-primary type="button" onclick="start()" Start
  button#snap.btn.btn-primary type="button" Ta bilde

.card
  .card-body
    #cameras

javascript:
  function start() {
    // Grab elements, create settings, etc.
    var video = document.getElementById('video');

    // Get access to the camera!
    if (navigator.mediaDevices && typeof navigator.mediaDevices.getUserMedia === 'function') {
      let devices
      try {
        navigator.mediaDevices.enumerateDevices().then(function(devices) {
          console.log(devices);
          devices.forEach(function(device) {
            console.log(device.kind + ": " + device.label +
                " id = " + device.deviceId);
          });
        }).catch(function(err) {
          console.log(err.name + ": " + err.message);
          $('#error_message').append(err);
        });
        $('#cameras').html(devices);
      } catch (error) {
        console.error(error)
        $('#error_message').append(error);
      }

      // Not adding `{ audio: true }` since we only want video now
      navigator.mediaDevices.getUserMedia({
        video: true
      }).then(function(stream) {
        video.srcObject = stream;
        video.play();
      }).catch(function(err) {
        console.log(err.name + ": " + err.message);
        $('#error_message').html(err.name + ": " + err.message);
      });
    }

    // Elements for taking the snapshot
    var canvas = document.getElementById('canvas');
    var context = canvas.getContext('2d');
    var video = document.getElementById('video');

    // Trigger photo take
    document.getElementById("snap").addEventListener("click", function() {
      context.drawImage(video, 0, 0, 320, 240);
      var dataUrl = canvas.toDataURL('image/png');
      $.ajax({
        type: "POST",
        url: "#{save_image_user_path}",
        data: {
          imgBase64: dataUrl
        }
      }).success(function(o) {
        console.log('saved: ' + o);
        $('#video').hide();
        $('#profile_image').attr('src', "#{profile_image_user_path(@user)}?hash=" + o)
      });
    });
  }

= file_field :user, :image_file, style: 'width: 206px'
