- @content_width = 9999

h1
  ' Oppmøteliste #{@group&.name}
  span.text-nowrap
    - prev_month = Date.new(@year, @month, 1) - 1.month
    a.btn.btn-primary> href=attendance_form_path(year: prev_month.year, month: prev_month.mon, group_id: @group.id)
      i.fa.fa-angle-left
    => month_name(@month).capitalize
    - next_month = Date.new(@year, @month, 1) + 1.month
    a.btn.btn-primary> href=attendance_form_path(year: next_month.year, month: next_month.mon, group_id: @group.id)
      i.fa.fa-angle-right
  =< @year

- @member_count = 0
- @date_totals = {}

- if @instructors.any?
  .table-responsive.mb-4
    table#instructors.table-striped.table-bordered width="100%"
      thead
        tr
          th Instruktører (#{@instructors.size})
          th År
          th Grad
          - if @birthdate_missing
            th F.Dato
          - @dates.each do |d|
            th.text-center = d.strftime('%d/%m')
      tbody
        - for member in @instructors
          = render 'attendance_row', member: member
        tr
          td colspan="3" &nbsp;
          - if @birthdate_missing
            td &nbsp;
          - @dates.each do |d|
            td.text-center
              a.btn.btn-secondary.btn-sm href=url_for(with_detour(controller: :attendances, action: :new, attendance: { practice_attributes: { group_schedule_id: @group.group_schedules.find { |gs| gs.weekday == d.cwday }.id, year: d.cwyear, week: d.cweek } }))
                i.fa.fa-plus

- @member_count = 0
- @date_totals = {}

.table-responsive
  table#members.table-striped.table-bordered width="100%"
    thead
      tr
        th Navn
        th År
        th Grad
        - if @birthdate_missing
          th F.Dato
        - @dates.each do |d|
          th.text-center = d.strftime('%d/%m')
    tbody
      - for member in @members
        = render 'attendance_row', member: member

      - @trials.each do |trial|
        - @member_count += 1
        - missing_contract = (trial.reg_dato + 14) < Date.current
        tr
          td
            a href=nkf_member_trial_path(trial) = "#{trial.fornavn} #{trial.etternavn}"
          td nowrap="true" align="center"
            = trial.age
          td align="center" nowrap="true"
            ' Prøvetid til
            = (trial.reg_dato + 14).strftime('%Y-%m-%d')
            - if missing_contract
              br
              = link_to 'Mangler kontrakt', controller: :members, action: :trial_missing_contract, id: trial.id
          - if @birthdate_missing
            td &nbsp;
          - member_trial_total = 0
          - @dates.each do |d|
            - if @group && trial.signup
              - group_schedule = @group.group_schedules.to_a.find { |gs| gs.weekday == d.cwday }
              - attendance = trial.signup.user.attendances.select { |a| a.practice.group_schedule == group_schedule && a.date == d }.first
              td id="attendance_#{trial.signup.user_id}_#{d.day}" align="center"
                - if attendance
                  - member_trial_total += 1
                  - @date_totals[d] ||= 0
                  - @date_totals[d] += 1
                  = render 'attendance_delete_link', attendance: attendance
                - else
                  = render 'attendance_create_link', user_id: trial.signup.user_id, group_schedule_id: group_schedule.id, date: d

              javascript:
                $("#attendance_#{trial.signup.user_id}_#{d.day}").bind("ajax:complete", function(e) {
                  data = e.originalEvent.detail[0].response
                  $(this).html(data);
                });

            - else
              td &nbsp;

      = render 'attendance_form_footer'

- if @passive_members.present?
  .table-responsive
    h2.mt-5 Passive medlemmer #{@group&.name} #{month_name(@month)} #{@year}

    table.table-striped.table-bordered width="100%"
      thead
        tr
          th Navn
          th År
          th Grad
          - if @birthdate_missing
            th F.Dato
          - @dates.each do |d|
            th.text-center = d.strftime('%d/%m')
      tbody
        - for member in @passive_members
          = render 'attendance_row', member: member
        tr
          td colspan="3" Totalt #{@passive_members.size}
          - if @birthdate_missing
            td &nbsp;
          - @dates.each do |d|
            td align="center"
          td
