<% @content_width = 1024 %>

<h2><%= @survey_request.survey.title %></h2>

<p>
  <%= @survey_request.survey.header %>
</p>

<%= form_for @survey_request, url: {action: :save_answers} do |f| %>
    <% @survey_request.survey.survey_questions.order(:position).each do |sq| %>
        <h4><%= sq.title %></h4>
        <% answer = @survey_request.survey_answers.find { |sa| sa.survey_question_id == sq.id } %>
        <% answer ||= @survey_request.survey_answers.build(survey_question_id: sq.id) %>
        <%= f.fields_for :survey_answers, answer do |sa| %>
            <%= sa.hidden_field :survey_question_id %>
            <% choices = sq.choices.try(:split, "\n") %>
            <% if sq.free_text %>
                <% choices << [:Annet, :annet] if choices %>
                <% other_value = answer.answer unless choices.try(:include?, answer.answer) %>
            <% end %>
            <div class="row">
              <% if choices %>
                  <div class="col-md-6">
                    <%= sa.select :answer, choices, {selected: other_value ? 'annet' : answer.answer},
                            multiple: sq.select_multiple, class: 'chosen-select form-control',
                            prompt: 'Velg',
                            onchange: "console.log($(this).val());
                    other_selected = $(this).val() == 'annet';
                    console.log(other_selected);
                    tf = $('#survey_request_survey_answers_attributes_#{sa.index}_answer_free');
                    console.log(tf);
                    tf.prop('disabled', !other_selected);
                    if (other_selected) {
                      tf.show().focus()
                    } else {
                      tf.hide()
                    }" %>
                  </div>
              <% end %>
              <% if sq.free_text %>
                  <div class="col-md-6">
                    <%= sa.text_field :answer_free, disabled: !other_value,
                            value: other_value, class: 'form-control expanding',
                            placeholder: 'Skriv beskrivelse her.',
                            style: ('display:none' unless other_value)
                    %>
                  </div>
              <% end %>

            </div>

        <% end %>
        <br/>
    <% end %>
    <br/>
    <%= f.submit class: 'btn btn-primary' %>
<% end %>
