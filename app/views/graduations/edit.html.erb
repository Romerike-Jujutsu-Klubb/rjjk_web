<% @content_width = 1024 %>

<div class="row">
  <div class="col-md-12">
    <%= render :partial => 'form' %>
  </div>
</div>
<br/>

<ul class="nav nav-tabs">
  <li class="active"><a href="#graduates" data-toggle="tab">Deltakere</a></li>
  <li><a href="#censors" data-toggle="tab">Sensorer</a></li>
</ul>

<div class="tab-content">
  <div class="tab-pane active" id="graduates">
    <% if @graduation.graduates.any? %>
        <table class="table col-md-9">
          <thead>
          <tr>
            <th>Deltakere (<%= @graduation.graduates.size %>)</th>
            <% unless @graduation.group.school_breaks? %>
                <th>Bestått</th>
            <% end %>
            <th>Grad</th>
            <th>Fjern</th>
          </tr>
          </thead>
          <tbody>
          <%
             for gr in @graduation.graduates
               mbr = gr.member
               fn = mbr.first_name.split(/\s+/).each { |x| x.capitalize! }.join(' ')
               ln = mbr.last_name.split(/\s+/).each { |x| x.capitalize! }.join(' ')
          %>
              <% below_minimum_age = mbr.age && mbr.age < gr.rank.minimum_age %>
              <% not_in_age_group = !(gr.rank.group.from_age..gr.rank.group.to_age).include?(mbr.age) %>
              <tr id="graduate_#{gr.id}">
                <td>
                  <%= link_to "#{fn} #{ln}", :controller => :members, :action => :edit, :id => mbr.id %>
                  <% if below_minimum_age || not_in_age_group %>
                      (<span style="color: red; white-space: nowrap"><%= mbr.age %>
                  år</span>)
                  <% end %>
                </td>
                <% unless @graduation.group.school_breaks? %>
                    <td>
                      <%= form_for gr do |f| %>
                          <%= f.radio_button :passed, true %>Ja<br/>
                          <%= f.radio_button :passed, false %>Nei
                      <% end %>
                    </td>
                <% end %>
                <td>
                  <%= form_for gr, :html => {:class => 'form-inline', :style => 'display: inline'} do |f| %>
                      <%= f.select :rank_id, Rank.all(:conditions => "martial_art_id = #{@graduation.group.martial_art_id}", :order => 'position').map { |r| ["#{r.name} #{r.colour}", r.id] } %>
                  <% end %>

                  <% graduated = gr.member.graduates.find { |gr2| gr2 != gr && gr2.passed && gr2.rank_id == gr.rank_id } %>
                  <% if graduated %>
                      <br/><span style="color: red">Har allerede bestått denne graden (<%= link_to graduated.graduation.held_on, :action => :index, :id => graduated.graduation_id %>
                  ).</span>
                  <% else %>
                      <% next_rank = mbr.next_rank(@graduation) %>
                      <% current_graduate = mbr.current_graduate(@graduation.group.martial_art, @graduation.held_on) %>
                      <% if next_rank && gr.rank != next_rank %>
                          <% if current_graduate %>
                              <br/>Har <%= current_graduate.rank.name %>
                              fra <%= link_to %Q{<font color="red">#{current_graduate.graduation.held_on}</font>}.html_safe, :controller => :graduations, :action => :index, :id => current_graduate.graduation.id %>
                          <% else %>
                              <br/>Har ingen grad fra før.
                          <% end %>
                          <br/><span style="color: red; ">Anbefalt neste grad er <%= next_rank.name %>
                  .</span>
                      <% end %>
                      <% if below_minimum_age %>
                          <br/><span style="color: red">Aldersgrense for <%= gr.rank.name %>
                  er <%= gr.rank.minimum_age %> år.</span>
                      <% elsif not_in_age_group %>
                          <br/><span style="color: red">Aldersgruppe for <%= gr.rank.name %>
                  er <%= gr.rank.group.from_age %>-<%= gr.rank.group.to_age %>
                  år.</span>
                      <% end %>
                      <% future_graduates = mbr.future_graduates(@graduation.held_on, @graduation.martial_art) %>
                      <% future_graduates.select { |fg| fg.rank.position < gr.rank.position }.each do |fg| %>
                          <br/>(konflikt: <%= link_to %Q{<font color="red">#{fg.rank.name} #{fg.graduation.held_on}</font>}.html_safe, :controller => :graduations, :action => :index, :id => fg.graduation.id %>
                          )
                      <% end %>

                      <% training_attendances = gr.training_attendances
                         minimum_attendances = gr.minimum_attendances
                         if training_attendances == 0 %>
                          <br/><span style="color: red">Har ikke vært på trening siden <%= current_graduate ? 'forrige gradering' : 'innmelding' %>
                  (<%= gr.training_start_date %>).</span>
                      <% elsif training_attendances < minimum_attendances %>
                          <br/>Har bare vært
                          på <%= link_to "#{training_attendances} trening#{'er' if training_attendances > 1}", {:controller => :attendances, :action => :since_graduation, :id => mbr.id, :date => @graduation.held_on}, :style => "color: red" %>
                          siden <%= current_graduate ? 'forrige gradering' : 'innmelding' %>
                          (<%= gr.training_start_date %>).
                          <br/>Minimum er <%= minimum_attendances %>
                          <% if minimum_attendances <= gr.registered_trainings %>
                              av <%= gr.registered_trainings %>
                          <% end %>
                          registrerte treninger.
                      <% end %>

                      <% if gr.member.left_on && gr.member.left_on < gr.graduation.held_on %>
                          <br/><span style="color: red">Deltakeren er utmeldt.</span>
                      <% end %>
                  <% end %>
                </td>
                <td>
                  <%= link_to({:controller => :graduates, :action => :destroy, :id => gr.id}, :method => :delete, :remote => true) do %>
                      <IMG SRC="<%= asset_path 'button-delete-16x16.png' %>" STYLE="border: 0;" title="Slett" ALT="Slett"></A>
                  <% end %>
                </td>
              </tr>
          <% end %>
          </tbody>
        </table>
    <% else %>
        <p>Det er ikke lagt til noen deltakere på denne graderingen enda.</p>
    <% end %>
  </div>


  <div class="tab-pane" id="censors">
    <h4>Sensorer
      (<%= link_to 'Skjema', :action => :censor_form, :id => @graduation.id %>,
      <%= link_to 'PDF', :action => :censor_form_pdf, :id => @graduation.id %>)
    </h4>

    <% if @graduation.censors.any? %>
        <div id="censors_row" class="row">
          <% @graduation.censors.each_with_index do |cen, i|
            fn = cen.member && cen.member.first_name.split(/\s+/).each { |x| x.capitalize! }.join(' ')
            ln = cen.member && cen.member.last_name.split(/\s+/).each { |x| x.capitalize! }.join(' ')
            name = "#{fn} #{ln}"
          %>
              <div class="col-md-3">
                <%= name %>
                <%= cen.member.name %>
                <%= link_to({:controller => :censors, :action => :destroy, :id => cen.id},
                        :data => {:remote => true, :method => :delete}) do %>
                    <img src="<%= asset_path 'button-delete-16x16.png' %>" style="border: 0;" title="Slett sensor <%= name %>" ALT="Slett sensor <%= name %>"/>
                <% end %>
              </div>
          <% end %>
        </div>
        <br/>
    <% end %>

    <%= form_for @censor, :url => with_detour(new_censor_path) do |f| %>
        <%= f.hidden_field :graduation_id %>
        <!-- FIXME(uwe):  Legg på en linje sammen -->
        <%= f.select :member_id, Member.instructors.map { |m| [m.name, m.id] }.sort, {}, :class => 'form-control' %>
        <%= f.submit 'Legg til sensor', :class => 'btn btn-default' %>
    <% end %>

  </div>

</div>

<%= javascript_tag do %>
    $('a[data-method=delete]').bind('ajax:success', function(event, data, status, xhr) {
    $(event.target).closest('tr').remove();
    });
<% end %>
<%= javascript_tag do %>
    $('a[data-method=delete]').bind('ajax:success', function(event, data, status, xhr) {
    $(event.target).closest('.row').remove();
    });
<% end %>
