<% @content_width = 1024 %>

<% if @graduation.held_on < Date.today && @approval %>
    <% if @approval.approved_grades_at.nil? %>
        <%= link_to 'Godkjenn', {:action => :approve, :id => @graduation.id},
                :class => 'btn btn-primary pull-right', :method => :post %>
    <% else %>
        <div class="btn btn-success pull-right">Godkjent</div>
    <% end %>
<% end %>

<h2>Gradering <%= @graduation.group.name %> <%= @graduation.held_on %></h2>

<ul class="nav nav-tabs">
  <li class="active"><a href="#graduates" data-toggle="tab">Deltakere</a></li>
  <li><a href="#censors" data-toggle="tab">
    Eksaminatorer / Sensorer</a>
  <li><a href="#forms" data-toggle="tab">Skjema</a></li>
  <li><a href="#form" data-toggle="tab">Dato / Gruppe</a></li>
</ul>

<div class="tab-content">
  <div class="tab-pane active" id="graduates">
    <% if @graduation.graduates.any? %>
        <table class="table col-md-9">
          <thead>
          <tr>
            <th>Deltakere (<%= @graduation.graduates.size %>)</th>
            <% unless @graduation.group.school_breaks? %>
                <th>Bestått</th>
            <% end %>
            <th>Grad</th>
            <th>Fjern</th>
          </tr>
          </thead>
          <tbody>
          <%
             for gr in @graduation.graduates.sort_by { |gr| -gr.rank.position }
               mbr = gr.member
               fn = mbr.first_name.split(/\s+/).each { |x| x.capitalize! }.join(' ')
               ln = mbr.last_name.split(/\s+/).each { |x| x.capitalize! }.join(' ')
          %>
              <% below_minimum_age = mbr.age(@graduation.held_on) && mbr.age(@graduation.held_on) < gr.rank.minimum_age %>
              <% not_in_age_group = !(gr.rank.group.from_age..gr.rank.group.to_age).include?(mbr.age(@graduation.held_on)) %>
              <tr id="graduate_#{gr.id}">
                <td>
                  <%= link_to "#{fn} #{ln}", :controller => :members, :action => :edit, :id => mbr.id %>
                  <% if below_minimum_age || not_in_age_group %>
                      (<span style="color: red; white-space: nowrap"><%= mbr.age(@graduation.held_on) %>
                  år</span>)
                  <% end %>
                </td>
                <% unless gr.passed? && @graduation.group.school_breaks? %>
                    <td>
                      <%= form_for gr, :html => {:remote => true} do |f| %>
                          <%= f.radio_button :passed, true, :onchange => "$('#passed_btn_#{gr.id}').click()" %>
                          Ja<br/>
                          <%= f.radio_button :passed, false, :onchange => "$('#passed_btn_#{gr.id}').click()" %>
                          Nei
                          <%= f.submit :id => "passed_btn_#{gr.id}", :class => 'hidden' %>
                      <% end %>
                    </td>
                <% end %>
                <td>
                  <%= form_for gr, :html => {:remote => true, :style => 'display: inline'} do |f| %>
                      <%= f.select :rank_id, Rank.all(:conditions => "martial_art_id = #{@graduation.group.martial_art_id}",
                              :order => 'position').map { |r| ["#{r.name} #{r.colour}", r.id] },
                              {}, :onchange => "$('#rank_btn_#{gr.id}').click()" %>
                      <%= f.submit :id => "rank_btn_#{gr.id}", :class => 'hidden' %>
                  <% end %>

                  <% graduated = gr.member.graduates.find { |gr2| gr2 != gr && gr2.passed && gr2.rank_id == gr.rank_id } %>
                  <% if graduated %>
                      <br/><span style="color: red">Har allerede bestått denne graden (<%= link_to graduated.graduation.held_on, :action => :index, :id => graduated.graduation_id %>
                  ).</span>
                  <% else %>
                      <% next_rank = mbr.next_rank(@graduation) %>
                      <% current_graduate = mbr.current_graduate(@graduation.group.martial_art, @graduation.held_on) %>
                      <% if next_rank && gr.rank != next_rank %>
                          <% if current_graduate %>
                              <br/>Har <%= current_graduate.rank.name %>
                              fra <%= link_to %Q{<font color="red">#{current_graduate.graduation.held_on}</font>}.html_safe, :controller => :graduations, :action => :index, :id => current_graduate.graduation.id %>
                          <% else %>
                              <br/>Har ingen grad fra før.
                          <% end %>
                          <br/><span style="color: red; ">Anbefalt neste grad er <%= next_rank.name %>
                  .</span>
                      <% end %>
                      <% if below_minimum_age %>
                          <br/><span style="color: red">Aldersgrense for <%= gr.rank.name %>
                  er <%= gr.rank.minimum_age %> år.</span>
                      <% elsif not_in_age_group %>
                          <br/><span style="color: red">Aldersgruppe for <%= gr.rank.name %>
                  er <%= gr.rank.group.from_age %>-<%= gr.rank.group.to_age %>
                  år.</span>
                      <% end %>
                      <% future_graduates = mbr.future_graduates(@graduation.held_on, @graduation.martial_art) %>
                      <% future_graduates.select { |fg| fg.rank.position < gr.rank.position }.each do |fg| %>
                          <br/>(konflikt: <%= link_to %Q{<font color="red">#{fg.rank.name} #{fg.graduation.held_on}</font>}.html_safe, :controller => :graduations, :action => :index, :id => fg.graduation.id %>
                          )
                      <% end %>

                      <% training_attendances = gr.training_attendances
                         minimum_attendances = gr.minimum_attendances
                         if training_attendances == 0 %>
                          <br/><span style="color: red">Har ikke vært på trening siden <%= current_graduate ? 'forrige gradering' : 'innmelding' %>
                  (<%= gr.training_start_date %>).</span>
                      <% elsif training_attendances < minimum_attendances %>
                          <br/>Har bare vært
                          på <%= link_to "#{training_attendances} trening#{'er' if training_attendances > 1}", {:controller => :attendances, :action => :since_graduation, :id => mbr.id, :date => @graduation.held_on}, :style => "color: red" %>
                          siden <%= current_graduate ? 'forrige gradering' : 'innmelding' %>
                          (<%= gr.training_start_date %>).
                          <br/>Minimum er <%= minimum_attendances %>
                          <% if minimum_attendances <= gr.registered_trainings %>
                              av <%= gr.registered_trainings %>
                          <% end %>
                          registrerte treninger.
                      <% end %>

                      <% if gr.member.left_on && gr.member.left_on < gr.graduation.held_on %>
                          <br/><span style="color: red">Deltakeren er utmeldt.</span>
                      <% end %>
                  <% end %>
                </td>
                <td>
                  <%= link_to({:controller => :graduates, :action => :destroy, :id => gr.id}, :method => :delete, :remote => true) do %>
                      <IMG SRC="<%= asset_path 'button-delete-16x16.png' %>" STYLE="border: 0;" title="Slett" ALT="Slett"></A>
                  <% end %>
                </td>
              </tr>
          <% end %>
          </tbody>
        </table>
    <% else %>
        <p>Det er ikke lagt til noen deltakere på denne graderingen enda.</p>
    <% end %>
  </div>


  <div class="tab-pane" id="censors">
    <div class="row">
      <div class="col-md-3">
        <h4>Eksaminatorer</h4>

        <div id="examiners_row" class="row">
          <% @graduation.censors.select { |c| c.examiner }.each do |cen| %>
              <div class="col-md-12">
                <%= link_to({:controller => :censors, :action => :destroy, :id => cen.id},
                        :data => {:remote => true, :method => :delete}) do %>
                    <img src="<%= asset_path 'button-delete-16x16.png' %>" style="border: 0;" title="Slett eksaminator <%= cen.member.name %>" ALT="Slett eksaminator <%= cen.member.name %>"/>
                <% end %>
                <%= cen.member.name %>
              </div>
          <% end %>
        </div>
        <br/>

        <%= form_for @censor, :url => with_detour(censors_path), :html => {:method => :post} do |f| %>
            <%= f.hidden_field :graduation_id %>
            <%= f.hidden_field :examiner, :value => 1 %>

            <div class="input-group">
              <%= f.select :member_id, ['Velg instruktør'] + Member.instructors.map { |m| [m.name, m.id] }.sort,
                      {}, :class => 'form-control', :onchange => 'form.submit()' %>
              <span class="input-group-btn">
              <%= f.submit 'Legg til', :class => 'btn btn-default' %>
            </span>
            </div>
        <% end %>
      </div>

      <div class="col-md-9">
        <h4>Sensorer</h4>

        <div id="censors_row" class="row">
          <% @graduation.censors.each do |cen| %>
              <div class="col-md-4">
                <%= link_to({:controller => :censors, :action => :destroy, :id => cen.id},
                        :data => {:remote => true, :method => :delete}) do %>
                    <img src="<%= asset_path 'button-delete-16x16.png' %>" style="border: 0;" title="Slett sensor <%= cen.member.name %>" ALT="Slett sensor <%= cen.member.name %>"/>
                <% end %>
                <%= cen.member.name %>
              </div>
          <% end %>
        </div>
        <br/>
        <%= form_for @censor, :url => with_detour(censors_path), :html => {:method => :post} do |f| %>
            <%= f.hidden_field :graduation_id %>

            <div class="input-group">
              <%= f.select :member_id, ['Velg sensor'] + Member.instructors.map { |m| [m.name, m.id] }.sort,
                      {}, :class => 'form-control', :onchange => 'form.submit()' %>
              <span class="input-group-btn">
              <%= f.submit 'Legg til', :class => 'btn btn-default' %>
            </span>
            </div>
        <% end %>
      </div>
    </div>

  </div>

  <div class="tab-pane" id="forms">
    <ul>
      <li>Sensor:
        <%= link_to 'PDF', :action => :censor_form_pdf, :id => @graduation.id %>
        /
        <%= link_to 'HTML', :action => :censor_form, :id => @graduation.id %>
      </li>
      <li><%= link_to 'Diplomer', {:action => :certificates, :id => @graduation.id} %></li>
    </ul>
  </div>

  <div class="tab-pane" id="form">
    <div class="row">
      <div class="col-md-6">
        <%= render 'form' %>
      </div>
    </div>
  </div>

</div>

<%= javascript_tag do %>
    $('a[data-method=delete]').bind('ajax:success', function(event, data, status, xhr) {
    $(event.target).closest('tr').remove();
    $(event.target).closest('.row').remove();
    });
<% end %>
