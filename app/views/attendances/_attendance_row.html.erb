<% @member_count += 1 %>
<% missing_contract = member.billing_type != 'MANUELL GIRO' && member.nkf_member.ventekid && member.nkf_member.ventekid !~ /^333000000004/ && member.joined_on < 61.days.ago.to_date %>
<% @blank_lines -= (missing_contract ? 3 : 1) %>
<tr class="<%= cycle('odd', 'even') %>">
  <td nowrap="true" onclick="window.location = '<%=url_for(:controller => :members, :action => :edit, :id => member.id) %>'">
    <%= h member.first_name %> <%= h member.last_name %> <%= '(Permisjon)' if member.nkf_member.medlemsstatus == 'P' -%>
    <% if missing_contract %>
        <br/><%= member.invoice_email %>
        <br/><%= member.nkf_member.ventekid %>
    <% end %>
  </td>
  <td nowrap="true" align="right">
    <%= h member.age %>
  </td>
  <td nowrap="true">
    <% if member.left_on && member.left_on < (@dates[0] + 2.months) %>
        Utmeldt fra <%= member.left_on %>
    <% elsif @group %>
        <%= h member.current_rank(@group.martial_art, @dates.first).try(:colour) %>
    <% else %>
        &nbsp;
    <% end %>
    <% if missing_contract %>
        <br/><%= link_to 'Mangler kontrakt', :action => :missing_contract, :id => member.id %>
        <br/>Innmeldt: <%= member.joined_on.strftime('%Y-%m-%d') %>
    <% end %>
  </td>
  <% if @birthdate_missing %>
      <td><%= h member.birthdate %>&nbsp;</td>
  <% end %>
  <% member_total = 0 %>
  <% @dates.each do |d| %>
      <% if @group %>
          <% group_schedule = @group.group_schedules.to_a.find { |gs| gs.weekday == d.cwday } %>
          <% attendance = member.attendances.select { |a| a.group_schedule_id == group_schedule.id && a.date == d }.first %>
          <td id="attendance_<%= member.id %>_<%= d.day %>" align="center">
            <% if attendance %>
                <% member_total += 1 %>
                <% @date_totals[d] ||= 0 %>
                <% @date_totals[d] += 1 %>
                <%= render :partial => 'attendance_delete_link', :locals => {:attendance => attendance} %>
            <% else %>
                <%= render :partial => 'attendance_create_link', :locals => {:member_id => member.id, :group_schedule_id => group_schedule.id, :date => d} %>
            <% end %>
          </td>

          <%= javascript_tag do %>
              $("#attendance_<%= member.id %>_<%= d.day %>").bind("ajax:complete", function(et, e){
              $(this).html(e.responseText);
              });
          <% end %>
      <% else %>
          <td>&nbsp;</td>
      <% end %>
  <% end %>
  <% half_year_total = member.attendances.select { |a| a.group_schedule.group_id == @group.id && a.date >= (@dates.last - 6.months) }.size %>
  <td align="center">
    <%= half_year_total %>
    /
    <%= @dates.map { |d| member.attendances_since_graduation(d, @group).size }.max %>
  </td>
</tr>
