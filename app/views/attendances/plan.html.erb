<p>For å kunne organisere treningene fremover ønsker vi at alle merker av når de planlegger å komme
  og når de ikke kan komme.</p>

<p>Trykk på "<strong>Kommer!</strong>"-knappen slik at den blir
  <span style="color: #5BB75B">grønn</span> på de treningene du planlegger å komme på, eller velg
  årsak
  fra listen på de treningene du ikke kan delta på.</p>

<% @weeks.each.with_index do |(year, week), i| %>

    <h4><%= i == 0 ? 'Denne uken' : 'Neste uke' %></h4>

    <table>
      <tr>
        <% @group_schedules.each do |gs| %>
            <% date = Date.commercial(year, week, gs.weekday) %>
            <th>
              <%= t(:date)[:day_names][gs.weekday] %>
              <%= date.day %>.
              <%= t(:date)[:month_names][date.mon] %>
            </th>
        <% end %>
      </tr>
      <tr>
        <% @group_schedules.each do |gs| %>
            <%
               ats = @attendances.select { |a| a.group_schedule == gs && a.year == year && a.week == week }
               initial_text = 'Kommer!'
               initial_icon = 'icon-thumbs-up'
               initial_class = nil
               if ats.any? { |a| [Attendance::ATTENDED, Attendance::WILL_ATTEND].include?(a.status) }
                 initial_class = 'btn-success '
               else
                 Attendance::STATES.each do |state, link_text, link_icon, link_class|
                   if ats.any? { |a| a.status == state }
                     initial_text = link_text
                     initial_icon = link_icon
                     initial_class = link_class
                     break
                   end
                 end
               end
            %>
            <td>
              <div class="btn-group">
                <%= link_to({:controller => :attendances, :action => :announce, :id => Attendance::WILL_ATTEND, :gs_id => gs.id, :year => year, :week => week},
                            :method => :post, :remote => true, :id => "btn_#{year}_#{week}_#{gs.id}",
                            :class => "btn #{initial_class} input-small",
                            :onclick => "$(this).toggleClass('btn-success').removeClass('btn-info btn-warning btn-danger').html('<i class=\"icon-thumbs-up\"></i> Kommer!') ; return false") do %>
                    <i class="<%= initial_icon %>"></i>
                    <%= initial_text %>
                <% end %>
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#"><span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <% Attendance::STATES.each do |state, link_text, link_icon, link_class| %>
                      <li>
                        <%= link_to({:controller => :attendances, :action => :announce, :id => state, :gs_id => gs.id, :year => year, :week => week},
                                    :mmethod => :post, :remote => true, :id => "btn_#{year}_#{week}_#{gs.id}",
                                    :onclick => "$('#btn_#{year}_#{week}_#{gs.id}').removeClass('btn-info btn-success btn-warning btn-danger').addClass('#{link_class}').html($(this).html()); $('[data-toggle=dropdown]').parent().removeClass('open'); return true") do %>
                            <i class="<%= link_icon %>"></i>
                            <%= link_text %>
                        <% end %>
                      </li>
                  <% end %>
                </ul>
              </div>
            </td>
        <% end %>
      </tr>
    </table>

<% end %>

<!--
<h4>Melding til instruktør</h4>
<%= text_area :attendance, :message, :class => 'input-xxlarge', :rows => 6 %>
<%= submit_tag 'Lagre', :class => 'btn' %>
-->

<%= back_or_link_to 'Tilbake', nil %>
