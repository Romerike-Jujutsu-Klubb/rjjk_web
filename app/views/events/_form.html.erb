<% @content_width = 880 %>

<%= tinymce %>

<ul class="nav nav-tabs">
  <li class="active"><a href="#description" data-toggle="tab">Beskrivelse</a></li>
  <li><a href="#invitation" data-toggle="tab">Invitasjon</a></li>
  <li><a href="#invitees" data-toggle="tab">Deltagere</a></li>
</ul>

<%= form_for(@event) do |f| %>
    <%= f.error_messages %>

    <div class="tab-content">
      <div class="tab-pane active" id="description">

        <p style="float: left; margin-right: 1em; padding-bottom: 0">
          <%= f.label :name, 'Hendelse' %>
          <%= f.text_field :name, :size => 52, :class => 'input-xlarge' %>
        </p>

        <p style="float: left; margin-right: 1em; padding-bottom: 0">
          <%= f.label :start_at, 'Fra' %>
          <%= f.datetime_picker :start_at, :value => @event.start_at.try(:strftime, '%Y-%m-%d %H:%M'),
                                :dateFormat => 'yy-mm-dd', :timeFormat => 'hh:mm', :firstDay => 1,
                                :class => 'input-medium' %>
        </p>

        <p style="float: left; margin-right: 1em; padding-bottom: 0">
          <%= f.label :end_at, 'Til (valgfritt)' %>
          <%= f.datetime_picker :end_at, :value => @event.end_at.try(:strftime, '%Y-%m-%d %H:%M'),
                                :dateFormat => 'yy-mm-dd', :timeFormat => 'hh:mm', :firstDay => 1,
                                :class => 'input-medium' %>
        </p>

        <br clear="all"/>

        <p>
          <%= f.label :beskrivelse %>
          <%= f.text_area :description, :class => :tinymce %>
        </p>
      </div>

      <div class="tab-pane" id="invitation">
        <% if @event.id %>
            <div style="float: right">
              <table>
                <tr>
                  <th>Gruppe</th>
                  <th>Invitert</th>
                </tr>
                <% for g in @groups %>
                    <tr>
                      <td><%= g.name %></td>
                      <td>
                        <%= check_box :group, 'id', {:multiple => true, :checked => @event.groups.include?(g)}, g.id, nil %>
                      </td>
                    </tr>
                <% end %>
              </table>
              <%#= f.button 'Send innbydelse til disse gruppene', :type => :button, :onclick => "$.get('#{url_for(:action => :invite, :id => @event.id, :recipients => :groups)}')" %>
            </div>
            <p>
              <%#= detour_to 'Rediger invitasjonen', :controller => :event_messages, :action => :edit, :id => @event.invitation %>
              <%= f.button 'Send meg eksempel på innbydelse', :type => :button, :onclick => "$.get('#{url_for(:action => :invite, :id => @event.id, :example => true)}')" %>
              <%= detour_to 'Legg til deltaker', :controller => :event_invitees, :action => :new, :event_invitee => {:event_id => @event.id} %>
              <%= detour_to 'Lag melding', :controller => :event_messages, :action => :new, :event_message => {:event_id => @event.id} %>
              <%#= f.button 'Send innbydelse til de inviterte', :type => :button, :onclick => "$.get('#{url_for(:action => :invite, :id => @event.id, :recipients => :invited)}')" %>
            </p>

            <p>
              <%= f.label :inviter %><%= "(#{@event.invitees.split(/\s*,\s*/).size})" if @event.invitees %>
              (Kommaseparert
              liste: Navn 1 &lt;e-post1&gt;, e-post2, Navn 3 &lt;e-post3&gt;,
              etc.)<br/>
              <%= f.text_area :invitees, :cols => 100, :rows => 3 %>
            </p>
        <% end %>

      </div>
      <div class="tab-pane" id="invitees">
        <% if @event.event_invitees.any? %>
            <div style="float: left">
              <table>
                <tr>
                  <th>Navn</th>
                  <th>Organisasjon</th>
                  <th>E-post</th>
                  <th>Telefon</th>
                  <th>Vil delta</th>
                  <th>Medhjelper</th>
                  <th>Betalt</th>
                  <th>Kommentar</th>
                  <th/>
                </tr>
                <% for inv in @event.event_invitees %>
                    <tr>
                      <td><%= detour_to inv.name, edit_event_invitee_path(inv) %></td>
                      <td><%= inv.organization %></td>
                      <td><%= link_to inv.email, "mailto:#{inv.email}?subject=#{@event.name}" %></td>
                      <td><%= inv.phone %></td>
                      <td align="center">
                        <%= {true => 'Ja', false => 'Nei'}[inv.will_attend] %>
                        <% if inv.will_attend %>
                            <%= detour_to('Bekreft', :controller => :event_invitee_messages,
                                          :action => inv.signup_confirmation ? :edit : :new,
                                          :id => inv.signup_confirmation.try(:id),
                                          :event_invitee_message => {
                                                  :message_type => EventInviteeMessage::MessageType::SIGNUP_CONFIRMATION,
                                                  :event_invitee_id => inv.id,
                                          }) unless inv.signup_confirmation.try(:ready_at)
                            %>
                            <%= detour_to('Avslå', :controller => :event_invitee_messages,
                                          :action => inv.signup_confirmation ? :edit : :new,
                                          :id => inv.signup_confirmation.try(:id),
                                          :event_invitee_message => {
                                                  :message_type => EventInviteeMessage::MessageType::SIGNUP_REJECTION,
                                                  :event_invitee_id => inv.id,
                                          }) unless inv.signup_confirmation.try(:ready_at)
                            %>
                        <% elsif inv.will_attend.nil? %>
                            <%= detour_to('Send invitasjon', :controller => :event_invitee_messages,
                                          :action => inv.invitation ? :edit : :new,
                                          :id => inv.invitation.try(:id),
                                          :event_invitee_message => {
                                                  :message_type => EventMessage::MessageType::INVITATION,
                                                  :event_invitee_id => inv.id,
                                          }) unless inv.invitation.try(:ready_at)
                            %>
                            <%= "Invitert #{inv.invitation.sent_at.to_date}" if inv.invitation.try(:sent_at) %>
                        <% end %>
                      </td>
                      <td align="center">
                        <%= {true => 'Ja', false => 'Nei'}[inv.will_work] if inv.will_attend %>
                      </td>
                      <td align="right"><%= inv.payed if inv.payed.to_i > 0 %></td>
                      <td><%= inv.comment %></td>
                      <td><%= detour_to 'Slett', url_for(inv), :data => {:confirm => 'Er du sikker?'}, :method => :delete %></td>
                    </tr>
                <% end %>
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td>Ja: <%= @event.event_invitees.select(&:will_attend).size %></td>
                </tr>
              </table>
            </div>
        <% end %>
      </div>
    </div>

    <p>
      <%= f.submit 'Lagre', :class => :btn %>
      <%= back_or_link_to 'Tilbake', events_path %>
      <%= link_to 'Oppmøteliste', :action => :attendance_form if @event.try(:event_invitees).try(:any?) %>
    </p>

<% end %>
