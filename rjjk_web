#!/bin/bash
#
# rjjk_web      Startup script for the RJJK web application
#
# chkconfig: 345 88 12
# description: RJJK web application
# pidfile: /u/apps/$APP/shared/log/mongrel.pid

. /etc/rc.d/init.d/functions

APP=rjjk_web
RUN_AS_USER=capistrano
PORT=3005
pidfile=${PIDFILE-/u/apps/$APP/shared/log/glassfish.pid}
APP_DIR="/u/apps/$APP/current"
LOG_DIR="/u/apps/$APP/shared/log"

START_CMD="cd $APP_DIR ; . use_jruby.sh ; jruby --version ; jruby -J-Xmx1G --server -S glassfish -d -p $PORT -e production -P $pidfile --runtimes-max 4 $APP_DIR 1>$LOG_DIR/stdout.log 2>$LOG_DIR/stderr.log"
# START_CMD="cd $APP_DIR ; export JAVA_HOME=/usr/java/default ; export JRUBY_HOME=/usr/local/jruby ; export PATH=\$JAVA_HOME/bin:\$JRUBY_HOME/bin:\$PATH ; jruby --version ; jruby -J-Xmx1G --server -S bundle exec glassfish -d -p $PORT -e production -P $pidfile --runtimes-max 1 $APP_DIR 1>$LOG_DIR/stdout.log 2>$LOG_DIR/stderr.log"
# START_CMD="cd $APP_DIR ; jruby -J-Xmx1G --server script/server -p $PORT -e production 1>$LOG_DIR/stdout.log 2>$LOG_DIR/stderr.log &"
STOP_CMD="kill `cat $pidfile`"

USER=`whoami`

run() {
	cmd=$1
	if [ "$USER" != "$RUN_AS_USER" ]; then
		echo Running as $USER
        echo su - $RUN_AS_USER -c \"$cmd\"
        su - $RUN_AS_USER -c "$cmd"
    else
    	echo $cmd
        eval $cmd
    fi
}

# See how we were called.
case "$1" in
  start)
	if [ -f $pidfile ] && ! ps h `cat $pidfile` > /dev/null
	then
	    rm -f $pidfile
	fi
#    run "$START_FERRET_CMD"
    run "$START_CMD"
        ;;
  stop)
#    run "$STOP_FERRET_CMD"
    run "$STOP_CMD"
    rm -f ${pidfile}
        ;;
  restart)
#    run "$STOP_FERRET_CMD"
#    run "$START_FERRET_CMD"
    run "$STOP_CMD"
    rm -f ${pidfile}
    run "$START_CMD"
        ;;
  status)
        ps -ef | grep $APP
        ;;
  *)
        echo "Usage: $prog {start|stop|restart|status}"
        exit 1
esac

exit 0
